name: CI1

on:
  workflow_run:
    workflows: ['Release1 Workflow']
    types: [completed]

jobs:
  build:
    name: 'âœï¸ Changelog generation'
    runs-on: ubuntu-latest
    steps:
      - name: 'Check release success?'
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        run: exit 1
      - name: 'ğŸ“¥ Check-out'
        uses: actions/checkout@v2
        with:
          ref: 'main'
          
      - name: Release Changelog Builder
        uses: mikepenz/release-changelog-builder-action@v3

      - name: Build Changelog
        id: github_release
        uses: mikepenz/release-changelog-builder-action@v3
        with:
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## ğŸ’¬ Other",
                    "labels": ["other"]
                },
                {
                    "title": "## ğŸ“¦ Dependencies",
                    "labels": ["dependencies"]
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 'ğŸš€ Create GitHub release'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.MVN_VERSION }}
          release_name: P0SR9-${{ env.GIT_HASH }}
          body: ${{steps.github_release.outputs.changelog}}
          
      - name: Deploy to Github Package Registry
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>gh</id><username>$(echo "$GITHUB_REPOSITORY" | awk -F / '{print $1}')</username><password>\${env.GITHUB_TOKEN}</password></server></servers></settings>" > ~/.m2/settings.xml
          REPO="gh::default::https://maven.pkg.github.com/${GITHUB_REPOSITORY}"
          mvn deploy -DaltDeploymentRepository="${REPO}" -DaltSnapshotDeploymentRepository="${REPO}" -DaltSnapshotDeploymentRepository="${REPO}" --file pom.xml

#       - name: "âœï¸ Generate full changelog"
#         id: generate-full-changelog
#         uses: ./
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#           headerLabel: "# ğŸ“‘ Changelog"
#           breakingLabel: '### ğŸ’¥ Breaking'
#           enhancementLabel: '### ğŸš€ Enhancements'
#           bugsLabel: '### ğŸ› Bug fixes'
#           deprecatedLabel: '### âš ï¸ Deprecations'
#           removedLabel: '### ğŸ”¥ Removals'
#           securityLabel: '### ğŸ›¡ï¸ Security'
#           issuesLabel: '### ğŸ“ Other issues'
#           prLabel: '### ğŸ“ Other pull requests'
#           addSections: '{"documentation":{"prefix":"### ğŸ“– Documentation","labels":["documentation"]},"tests":{"prefix":"### âœ… Testing","labels":["tests"]}}'
#           issues: true
#           issuesWoLabels: true
#           pullRequests: true
#           prWoLabels: true
#           author: true
#           unreleased: true
#           compareLink: true
#           stripGeneratorNotice: true
#           verbose: true
#       - name: "ğŸ–¨ï¸ Print changelog to console"
#         run: cat CHANGELOG.md
#       - name: "ğŸ“¤ Upload changelog"
#         uses: actions/upload-artifact@v1.0.0
#         with:
#           name: "Changelog"
#           path: CHANGELOG.md
