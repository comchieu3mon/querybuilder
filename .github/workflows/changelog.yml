name: Changelog Workflow

on:
  workflow_run:
    workflows: ['Release1 Workflow']
    types: [completed]

jobs:
  build:
    name: 'âœï¸ Changelog generation'
    runs-on: ubuntu-latest
    steps:
      - name: 'Check release success?'
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        run: exit 1

      - name: 'ðŸ“¥ Check-out'
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: master

      - name: 'âœï¸ Generate release changelog'
        uses: heinrichreimer/action-github-changelog-generator@v2.3
        id: generate-release-changelog
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          headerLabel: "# ðŸ“‘ Changelog"
          breakingLabel: '### ðŸ’¥ Breaking'
          enhancementLabel: '### ðŸš€ Enhancements'
          bugsLabel: '### ðŸ› Bug fixes'
          deprecatedLabel: '### âš ï¸ Deprecations'
          removedLabel: '### ðŸ”¥ Removals'
          securityLabel: '### ðŸ›¡ï¸ Security'
          issuesLabel: '### ðŸ“ Other issues'
          prLabel: '### ðŸ“ Other pull requests'
          addSections: '{"documentation":{"prefix":"### ðŸ“– Documentation","labels":["documentation"]},"tests":{"prefix":"### âœ… Testing","labels":["tests"]}}'
          issues: true
          issuesWoLabels: true
          pullRequests: true
          prWoLabels: true
          author: true
          unreleased: true
          compareLink: true
          stripGeneratorNotice: true
          verbose: true

      - name: Extract Maven project version
        run: echo ::set-output name=version::$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)
        id: project

      - name: The tag name is Maven project version
        run: echo "TAG=${{ steps.project.outputs.version }}" >> $GITHUB_ENV
     
      - name: Get Hash
        run: echo "GIT_HASH=$(git rev-parse --short "$GITHUB_SHA")" >> $GITHUB_ENV

      - name: 'ðŸš€ Create GitHub release'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.TAG }}
          release_name: P1SR13-${{ env.GIT_HASH }}
          body: ${{ steps.generate-release-changelog.outputs.changelog }}
  
